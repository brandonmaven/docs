---
title: LiveKit Integration
description: "Collect payments with LiveKit voice agents"
---

# LiveKit Integration

Integrate Maven with LiveKit Agents for voice-based payment collection.

<Info>
  LiveKit agents run on your infrastructure with function tools defined in code. This is a server-based integration similar to Twilio.
</Info>

## Overview

<Steps>
  <Step title="Get your Maven API key">
    Go to [Dashboard â†’ API Keys](https://app.trymaven.com/api-keys) and create a key
  </Step>
  <Step title="Add the payment tool to your agent">
    Define a function tool that calls Maven's API
  </Step>
  <Step title="Use SIP transfer">
    Transfer the call to Maven's IVR using LiveKit's SIP APIs
  </Step>
</Steps>

## Python Agent Integration

### 1. Define the Payment Tool

```python
from livekit.agents import function_tool, RunContext
from livekit.api import LiveKitAPI, TransferSIPParticipantRequest
import httpx
import os

@function_tool()
async def collect_payment(
    context: RunContext,
    amount: float,
    description: str = "",
    mode: str = "charge",
    customer_id: str = None,
) -> dict:
    """
    Transfer the customer to securely collect their credit card payment.

    Args:
        amount: Payment amount in dollars (e.g., 25.00)
        description: What the payment is for
        mode: "charge" to charge immediately, "tokenize" to just save card
        customer_id: Your internal customer ID
    """
    # Get caller phone from the SIP participant
    participant = context.participant
    caller = participant.attributes.get("sip.phoneNumber") or participant.identity

    # Create Maven session
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://api.trymaven.com/v1/sessions",
            headers={
                "Authorization": f"Bearer {os.environ['MAVEN_API_KEY']}",
                "Content-Type": "application/json"
            },
            json={
                "project": os.environ["MAVEN_PROJECT"],
                "caller": caller,
                "amount": int(amount * 100),  # Convert to cents
                "currency": "USD",
                "description": description,
                "mode": mode,
                "customer_id": customer_id,
                "callback": os.environ.get("LIVEKIT_SIP_NUMBER"),  # Transfer back
                "metadata": {"source": "livekit"}
            }
        )
        session = response.json()

    # Transfer the call to Maven's IVR
    api = LiveKitAPI()
    await api.sip.transfer_sip_participant(
        TransferSIPParticipantRequest(
            room_name=context.room.name,
            participant_identity=participant.identity,
            transfer_to=f"tel:{session['phone_number']}"
        )
    )

    return {
        "status": "transferring",
        "session_id": session["session_id"],
        "message": "Transferring to secure payment line"
    }
```

### 2. Add Tool to Your Agent

```python
from livekit.agents import AgentSession
from livekit.plugins import openai

agent = AgentSession(
    llm=openai.LLM(),
    tools=[collect_payment],  # Add the payment tool
)
```

### 3. Update Agent Instructions

```python
agent = AgentSession(
    llm=openai.LLM(),
    tools=[collect_payment],
    instructions="""
    You are a helpful assistant.

    When the customer is ready to pay, use the collect_payment tool with the amount.
    The customer will be transferred to enter their card details securely.
    After payment, they will be transferred back automatically.
    """
)
```

## TypeScript Agent Integration

```typescript
import { defineAgent, llm } from '@livekit/agents';
import { SIPClient } from '@livekit/api';

const collectPayment = llm.tool({
  description: 'Transfer the customer to securely collect their credit card payment',
  parameters: z.object({
    amount: z.number().describe('Payment amount in dollars'),
    description: z.string().optional().describe('What the payment is for'),
    mode: z.enum(['charge', 'tokenize']).default('charge'),
    customer_id: z.string().optional().describe('Your internal customer ID'),
  }),
  execute: async ({ amount, description, mode, customer_id }, { ctx }) => {
    const caller = ctx.participant.attributes['sip.phoneNumber'] || ctx.participant.identity;

    // Create Maven session
    const response = await fetch('https://api.trymaven.com/v1/sessions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.MAVEN_API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        project: process.env.MAVEN_PROJECT,
        caller,
        amount: Math.round(amount * 100),
        currency: 'USD',
        description,
        mode,
        customer_id,
        callback: process.env.LIVEKIT_SIP_NUMBER,
        metadata: { source: 'livekit' }
      })
    });

    const session = await response.json();

    // Transfer the call
    const sipClient = new SIPClient();
    await sipClient.transferSIPParticipant({
      roomName: ctx.room.name,
      participantIdentity: ctx.participant.identity,
      transferTo: `tel:${session.phone_number}`
    });

    return {
      status: 'transferring',
      session_id: session.session_id
    };
  }
});
```

## SIP Trunk Configuration

For LiveKit to transfer calls, you need:

1. **Outbound SIP Trunk** configured in LiveKit Cloud or self-hosted
2. **PSTN Transfer enabled** on your trunk
3. **Caller ID** configured for outbound calls

See [LiveKit SIP Documentation](https://docs.livekit.io/sip/) for trunk setup.

## Set Up Webhook (Optional)

To receive payment notifications, configure a webhook in your [Maven Dashboard](https://app.trymaven.com/projects).

Maven will POST to your webhook URL:

```json
{
  "event": "payment.success",
  "session_id": "abc-123",
  "amount": 2500,
  "currency": "USD",
  "card_brand": "visa",
  "card_last4": "4242"
}
```

## Transfer Back

To transfer the customer back after payment:

1. Set the `callback` parameter to your LiveKit SIP number
2. Configure a dispatch rule to route returning calls to your agent
3. Use the context endpoint to check if the caller just paid

### Check Payment Context

When a call is transferred back, check if they just paid:

```python
@function_tool()
async def check_payment_context(context: RunContext) -> dict:
    """Check if this caller just completed a payment."""
    caller = context.participant.attributes.get("sip.phoneNumber")

    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://api.trymaven.com/voice/context",
            json={"caller": caller}
        )
        return response.json()
```

---

## Testing

1. Use a `mvn_test_` API key (test mode)
2. When prompted for card, enter: `4242 4242 4242 4242`
3. Any future expiry date, any 3-digit CVV

<Info>
  Test mode simulates charges. No real money moves.
</Info>

---

## Environment Variables

```bash
MAVEN_API_KEY=mvn_test_xxx
MAVEN_PROJECT=my-project
LIVEKIT_SIP_NUMBER=+14155551234  # Your LiveKit SIP number for transfer-back
```

---

## Troubleshooting

<AccordionGroup>
  <Accordion title="Tool not being called">
    Make sure the tool is added to your AgentSession and your LLM instructions mention when to use it.
  </Accordion>

  <Accordion title="SIP transfer failing">
    Check that your outbound SIP trunk is configured correctly and PSTN transfer is enabled. Verify the Maven phone number format includes country code.
  </Accordion>

  <Accordion title="Payment failing">
    In test mode, use card `4242 4242 4242 4242`. Check your Maven dashboard for session status and error details.
  </Accordion>

  <Accordion title="Caller phone not found">
    The caller's phone number should be in `participant.attributes['sip.phoneNumber']`. If not present, check your dispatch rule configuration.
  </Accordion>
</AccordionGroup>
