---
title: VAPI Integration
description: Set up Maven as a payment collection tool for your VAPI voice AI agent
---

# VAPI Integration

Maven integrates natively with [VAPI](https://vapi.ai) voice AI agents. When your agent needs to collect a payment, it triggers a tool call that creates a Maven session and transfers the caller to Maven's IVR for secure card collection.

## How It Works

1. Customer is on a call with your VAPI voice agent
2. Agent determines payment is needed and calls the `collect_payment` tool
3. VAPI sends a webhook to Maven's endpoint with the payment details
4. Maven creates a session and returns a transfer phone number
5. VAPI transfers the caller to Maven's IVR
6. Maven's AI agent guides the customer through card collection
7. Maven processes the payment
8. Caller is transferred back to your agent (if `callback` is configured)

## Setup Options

You can set up the VAPI integration in two ways:

<Tabs>
  <Tab title="Auto-Setup (Dashboard)">

The fastest way. Maven creates the VAPI tools in your account automatically.

1. In your app, go to the **Integrations** tab and click **VAPI**
2. Enter your **VAPI Private Key** (from VAPI Dashboard > Account)
3. Select your Maven **app**, **gateway**, and **mode**
4. Optionally select a **VAPI Assistant** to attach the tools to
5. Click **Create Tools**

Maven creates two tools in your VAPI account:
- **collect_payment** — Function tool that creates a payment session
- **transfer_to_payment** — TransferCall tool that transfers to Maven's IVR

The webhook URL uses an [opaque token](/authentication#webhook-tokens) instead of your raw API key.

  </Tab>
  <Tab title="Manual Setup">

Configure the VAPI tool yourself with full control over parameters.

### Step 1: Get Your Maven API Key

Get a test API key from the [Maven Dashboard](https://prod.trymaven.com) (Settings > API Keys).

### Step 2: Configure the VAPI Tool

In your VAPI assistant, add an **API Request** tool or a **Custom Tool**:

<Tabs>
  <Tab title="API Request Tool">

**Method:** POST

**URL:**
```
https://pciapi.trymaven.com/integrations/vapi/webhook?token=YOUR_TOKEN
```

Or with legacy query params:
```
https://pciapi.trymaven.com/integrations/vapi/webhook?api_key=mvn_test_xxx&project=my-store&mode=charge&gateway=stripe
```

**Headers:**
```
Content-Type: application/json
```

**Body schema:**
```json
{
  "amount": { "type": "number", "description": "Payment amount in dollars (e.g. 150.00)" },
  "caller": { "type": "string", "description": "Customer phone in E.164 format" },
  "description": { "type": "string", "description": "What the payment is for" },
  "callback": { "type": "string", "description": "Phone number to transfer caller back to" }
}
```

  </Tab>
  <Tab title="Custom Tool (Webhook)">

**Tool name:** `collect_payment`

**Server URL:**
```
https://pciapi.trymaven.com/integrations/vapi/webhook?token=YOUR_TOKEN
```

**Parameters:**
```json
{
  "type": "object",
  "properties": {
    "amount": { "type": "number", "description": "Payment amount in dollars (e.g. 150.00)" },
    "caller": { "type": "string", "description": "Customer phone in E.164 format" },
    "description": { "type": "string", "description": "What the payment is for" },
    "callback": { "type": "string", "description": "Phone number to transfer caller back to" }
  },
  "required": ["amount"]
}
```

  </Tab>
</Tabs>

### Step 3: Configure Transfer

The webhook response includes a `transfer_number`. Configure a TransferCall tool in VAPI to transfer the caller to Maven's IVR number.

  </Tab>
</Tabs>

## Query Parameters

Whether using a token or legacy URL, these parameters control the session:

| Parameter | Required | Description | Default |
|-----------|----------|-------------|---------|
| `token` | Yes* | Opaque webhook token | — |
| `api_key` | Yes* | Maven API key (legacy) | — |
| `project` | Yes* | Project slug or UUID (legacy) | — |
| `mode` | No* | Payment mode (legacy) | `charge` |
| `gateway` | No* | Payment gateway (legacy) | `stripe` |

*Either `token` or `api_key` + `project` is required. Tokens encode all parameters (app, gateway, mode).

## Webhook Response

```json
{
  "session_id": "a1b2c3d4-...",
  "transfer_number": "+18005551234",
  "message": "Payment session created. Please transfer the caller to +18005551234 to securely collect their card details."
}
```

## Agent Prompt Example

Add this to your VAPI agent's system prompt:

```
When the customer needs to make a payment:
1. Confirm the amount with the customer
2. Call the collect_payment tool with the amount and the customer's phone number
3. Tell the customer: "I'm going to transfer you to our secure payment line. Once your payment is processed, you'll be transferred back to me."
4. Transfer the call to the number returned by the tool
5. When the customer returns, check the payment result and let them know the outcome
```

## Phone Number Requirements

Maven matches incoming IVR calls to sessions using the customer's phone number. For the transfer to work, Maven must see the **customer's real caller ID** — not your agent's phone number.

<Warning>
  If your VAPI assistant uses a **VAPI-owned phone number**, the transfer to Maven will show the VAPI number as the caller instead of the customer's real number. Maven won't be able to match the call to the session.

  **Fix:** Use your own phone number (e.g. a Twilio number you own) as the assistant's phone number instead of a VAPI-provided number. This ensures the customer's caller ID is preserved on transfer.
</Warning>

## Transfer-Back

Pass a `callback` number in the tool parameters to have Maven transfer the caller back to your VAPI agent after payment:

```json
{
  "amount": 49.99,
  "caller": "+14155551234",
  "callback": "+18005559999"
}
```



## Testing

1. Use a **test** API key (`mvn_test_xxx`) during development
2. Use your own phone number as the customer number
3. When transferred to the IVR, use test card numbers:
   - `4242 4242 4242 4242` (Visa, succeeds)
   - `4000 0000 0000 0002` (Visa, declined)
4. Check session status in the Maven Dashboard or via the API

<Warning>
  Even in test mode, the IVR places real calls. Use your own phone number during testing.
</Warning>

## Error Handling

The webhook returns errors with a `200` status code (so VAPI doesn't retry) and an `error` field:

```json
{
  "error": "caller phone number is required"
}
```

| Error | Cause | Fix |
|-------|-------|-----|
| `Missing api_key query parameter` | No auth in URL | Use a token or add `api_key` param |
| `Missing project query parameter` | No project in URL | Add `project` param or use a token |
| `Invalid API key` | Key is wrong or revoked | Check key in Dashboard |
| `caller phone number is required` | Tool didn't pass `caller` | Ensure agent provides customer phone |
| `amount is required` | Tool didn't pass `amount` | Ensure agent provides amount |

## Supported Formats

The webhook auto-detects two request formats:

1. **API Request tool** — Parameters are top-level: `{amount, caller, description}`
2. **Custom Tool webhook** — Wrapped in: `{type: "function-call", functionCall: {parameters: {...}}, call: {customer: {number: "..."}}}`
