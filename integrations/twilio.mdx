---
title: Twilio Integration
description: "Collect payments with Twilio voice"
---

# Twilio Integration

Integrate Maven with Twilio Voice using TwiML or Studio.

<Info>
  **Twilio Studio** can call Maven's API directly (no server needed), but your API key will be visible in Studio. **TwiML apps** require a server to generate responses. For a fully serverless experience, consider [VAPI](/integrations/vapi).
</Info>

## Overview

<Steps>
  <Step title="Get your Maven API key">
    Go to [Dashboard → API Keys](https://app.trymaven.com/api-keys) and create a key
  </Step>
  <Step title="Create a TwiML endpoint">
    Build a server endpoint that creates Maven sessions
  </Step>
  <Step title="Configure Twilio webhooks">
    Point Twilio to your endpoint when payment is needed
  </Step>
</Steps>

## TwiML Integration

### 1. Create Session Endpoint

```javascript
const express = require('express');
const app = express();

app.use(express.urlencoded({ extended: true }));

// POST /twilio/collect-payment
app.post('/twilio/collect-payment', async (req, res) => {
  const { From } = req.body;
  const amount = parseFloat(req.query.amount || '0');

  if (!amount || amount <= 0) {
    res.type('text/xml');
    return res.send(`
      <Response>
        <Say>I'm sorry, there was an error with the payment amount.</Say>
      </Response>
    `);
  }

  // Create Maven session
  const session = await fetch('https://api.trymaven.com/v1/sessions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.MAVEN_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      project: 'my-project',
      caller: From,
      amount: Math.round(amount * 100),  // Convert to cents
      currency: 'USD',
      mode: 'charge',
      callback: process.env.TWILIO_PHONE_NUMBER  // Optional: transfer back
    })
  });

  const { phone_number } = await session.json();

  // Return TwiML to transfer
  res.type('text/xml');
  res.send(`
    <?xml version="1.0" encoding="UTF-8"?>
    <Response>
      <Say>I'll transfer you now to enter your card details.</Say>
      <Dial action="/twilio/transfer-complete">
        <Number>${phone_number}</Number>
      </Dial>
    </Response>
  `);
});
```

### 2. Handle Transfer Complete

```javascript
app.post('/twilio/transfer-complete', (req, res) => {
  const { DialCallStatus } = req.body;

  res.type('text/xml');

  if (DialCallStatus === 'completed') {
    res.send(`
      <?xml version="1.0" encoding="UTF-8"?>
      <Response>
        <Say>Thank you for your payment. Is there anything else I can help with?</Say>
        <Gather input="speech" timeout="5" action="/twilio/next-action">
          <Say>Please say yes or no.</Say>
        </Gather>
      </Response>
    `);
  } else {
    res.send(`
      <?xml version="1.0" encoding="UTF-8"?>
      <Response>
        <Say>I'm sorry, the payment didn't go through. Would you like to try again?</Say>
        <Gather input="speech" timeout="5" action="/twilio/retry">
          <Say>Please say yes or no.</Say>
        </Gather>
      </Response>
    `);
  }
});
```

## Twilio Studio

In Studio, you can call Maven's API directly without needing your own server:

### Studio Flow Example

```
[Incoming Call]
    ↓
[Make HTTP Request]
    URL: https://api.trymaven.com/v1/sessions
    Method: POST
    Headers:
      Authorization: Bearer YOUR_MAVEN_API_KEY
      Content-Type: application/json
    Body: {
      "project": "my-project",
      "caller": "{{contact.channel.address}}",
      "amount": {{widgets.get_amount.result}} * 100,
      "currency": "USD"
    }
    ↓
[Connect Call To]
    Number: {{widgets.create_session.parsed.phone_number}}
    ↓
[Split Based On]
    Variable: {{widgets.connect_call.CallStatus}}
    "completed" → [Say "Payment successful"]
    "busy/failed/no-answer" → [Say "Payment failed"]
```

<Warning>
  Putting your API key in Twilio Studio means anyone with Studio access can see it. For production, consider using a server endpoint or Twilio Functions to keep the key secure.
</Warning>

## Set Up Webhook (Optional)

To receive payment notifications, configure a webhook in your [Maven Dashboard](https://app.trymaven.com/projects).

Maven will POST to your webhook URL:

```json
{
  "event": "payment.success",
  "session_id": "abc-123",
  "amount": 2500,
  "currency": "USD",
  "card_brand": "visa",
  "card_last4": "4242"
}
```

---

## Testing

1. Use a `mvn_test_` API key (test mode)
2. When prompted for card, enter: `4242 4242 4242 4242`
3. Any future expiry date, any 3-digit CVV

<Info>
  Test mode simulates charges. No real money moves.
</Info>

---

## Troubleshooting

<AccordionGroup>
  <Accordion title="TwiML not working">
    Make sure your endpoint returns `Content-Type: text/xml` and valid TwiML. Use Twilio's TwiML validator to debug.
  </Accordion>

  <Accordion title="Call not transferring">
    Check that the Maven session was created successfully. Log the `phone_number` value to verify it's being returned correctly.
  </Accordion>

  <Accordion title="Payment failing">
    In test mode, use card `4242 4242 4242 4242`. Check your Maven dashboard for session status and error details.
  </Accordion>

  <Accordion title="Dial status not received">
    Make sure your `<Dial>` tag has an `action` attribute pointing to your status handler endpoint.
  </Accordion>
</AccordionGroup>
